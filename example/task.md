# Анализ технического задания: Минимальная рентабельная добыча (МРД)

## 1. Общая информация о задаче

### 1.1 Основная цель
Реализация новой вкладки "Минимальная рентабельная добыча" (МРД) в настройках мониторинга с возможностью загрузки эталонных значений через Excel-файл по заданному шаблону.

### 1.2 Замена функционала
Необходимо заменить существующие вкладки:
- "Минимальный рентабельный прирост"
- "Минимальная рентабельная приемистость"

Эти вкладки должны быть полностью скрыты из интерфейса настроек.

## 2. Функциональные требования

### 2.1 Основные компоненты интерфейса

#### 2.1.1 Таблица МРД
Основной элемент интерфейса, отображающий эталонные значения минимальной рентабельной добычи.

**Структура столбцов:**
1. Месторождение
2. Код проекта
3. Тип проекта по ППДН
4. Подгруппа мероприятий в зависимости от затрат
5. Дата начала проекта
6. Горизонт расчёта, год
7. Кол-во скважин в проекте, шт
8. Затраты, млн. руб
9. Мин. рент. ДДН до горизонта расчёта по проекту, тыс. т
   - ДНС
   - НДД
   - ТРИЗ:
     - Бажен КД=0
     - 2 категория КД=0,2
     - 3 категория КД=0,4
     - Тюменская свита КД=0,8
     - Территориальные льготы
     - Выработка более 80%
     - Разработка за 65 широтой

#### 2.1.2 Панель инструментов
Верхняя панель содержит:
- Выпадающий список для выбора года (2020-2035, на 10 лет вперед от текущего)
- Кнопка "Загрузить Excel"
- Кнопка "Скачать Excel"

#### 2.1.3 Боковая панель "История загрузок"
Отображает историю загруженных файлов в виде карточек с информацией:
- Дата загрузки
- ФИО пользователя
- Комментарий
- Ошибки (только для последней загрузки)

### 2.2 Правила отображения и сортировки

#### 2.2.1 Сортировка по умолчанию
Записи сортируются по алфавиту в следующем приоритете:
1. Название месторождения
2. Код проекта
3. Тип проекта по ППДН

#### 2.2.2 Правила округления значений

| Поле | Правило округления | Примечание |
|------|-------------------|------------|
| Мин. рент. ДДН (блок) | До тысячных (3 знака после запятой) | Округление только на фронте |
| Количество скважин | До целых | - |
| Горизонт расчёта | До десятых (1 знак после запятой) | При наведении - до тысячных |
| Затраты | До тысячных (3 знака после запятой) | - |

**Важно:** Округление выполняется только на фронтенде, в БД хранятся полные значения.

#### 2.2.3 Интерактивные элементы
- Тултип для столбца "ДНС" с текстом "Действующая налоговая система"
- Возможность ручной сортировки и фильтрации по всем столбцам
- Горизонтальный скролл с закреплением первых 3 столбцов
- Вертикальный скролл с закреплением заголовков

### 2.3 Загрузка данных из Excel

#### 2.3.1 Условия доступности загрузки
- Кнопка "Загрузить Excel" доступна только для текущего или будущего года
- Для прошлых лет кнопка скрыта
- Кнопка "Скачать Excel" доступна для любого года

#### 2.3.2 Модальное окно загрузки
**Элементы:**
- Информер с текстом о проверке обязательных полей
- Поле для загрузки файла
- Поле "Комментарий" (обязательное)
- Кнопка "Отмена"
- Кнопка "Загрузить" (активна только при загруженном файле и заполненном комментарии)

#### 2.3.3 Процесс загрузки
1. Отправка запроса `/api/monitoring/v1/Profitability/Upload`
2. Валидация данных, сохранение корректных строк
3. Отображение лоадера во время обработки
4. Закрытие модального окна при статусе 200
5. Запрос обновленных данных таблицы

**Ограничения во время загрузки:**
- Невозможно загрузить новый файл
- Невозможно выгрузить данные таблицы

### 2.4 Валидация загруженных данных

#### 2.4.1 Поддерживаемые форматы
- .xls
- .xlsx

#### 2.4.2 Порядок проверок

**1. Проверка обязательных полей**
Обязательные столбцы:
- Месторождение
- Код проекта
- Дата начала проекта
- Тип проекта по ППДН
- Горизонт расчёта
- Количество скважин в проекте
- Затраты

Текст ошибки: "Не заполнены обязательные поля в строках <номер строки>, <номер строки>, …"

**2. Проверка года ИП**
Сохраняются только строки с датой из выбранного года.

Текст ошибки: "Год проекта не соотвествует выбанному в интерфейсе в строках <номер строки>, …"

**3. Проверка года для роли "Эксперт"**
Год ИП должен быть >= текущему году.

**4. Проверка справочных данных**
Проверяется соответствие справочникам СПекТР:
- Справочник месторождений: `register.field`, поле `field_name`
- Справочник видов мероприятий: `gtm_monitoring.EraEventTypeGroups`, название = `ParentId→Name/Name`, где `IsDeleted = false`
- Справочник подгрупп мероприятий: `data_store.GtmTypeReference`, поле `Name`, идентификатор `GtmCode`

Тексты ошибок:
- "Не найдено указанное месторождение в строках <номер строки>, …"
- "Не найдено указанное мероприятие в строках <номер строки>, …"
- "Не найдена указанная подгруппа мероприятия в строках <номер строки>, …"

**5. Проверка форматов значений**

| Столбец | Тип данных | Ограничение |
|---------|-----------|-------------|
| Дата начала проекта | Дата | Форматы: дд.мм.гггг, гггг.мм.дд (разделители: -, /, .) |
| Горизонт расчёта, год | Число | Разделитель: точка или запятая; ≥0 |
| Количество скважин | Целое число | ≥0 |
| Блок МРД | Число | Разделитель: точка или запятая; ≥0 |
| Месторождение | Текст | Не пусто |
| Код проекта | Текст | Не пусто |
| Тип проекта по ППДН | Текст | Не пусто |
| Подгруппа мероприятий | Текст | Может быть пустым |

Тексты ошибок:
- "Некорректный формат (число) в строках <номер строки>, <номер строки>, …"
- "Некорректный формат (дата) в строках <номер строки>, <номер строки>, …"

**6. Проверка уникальности записей**
Уникальность определяется по комбинации полей:
- Месторождение
- Код проекта
- Дата начала проекта
- Мероприятие (Тип проекта по ППДН)
- Подгруппа

Текст ошибки: "Дублирующие значения в строках <номер строки>, <номер строки>, …"

### 2.5 Сохранение данных

#### 2.5.1 Целевая таблица
Данные сохраняются в сущность `MinProductionLevelSettings` (схема `gtm_monitoring`, БД `monitoring`).

#### 2.5.2 Структура таблицы MinProductionLevelSettings

| Поле | Описание | Тип данных | Not Null | Действие |
|------|----------|-----------|----------|----------|
| Id | Уникальный идентификатор | uuid | Да | Без изменений |
| OrgId | Идентификатор ДО | int4 | Да | Без изменений |
| FieldId | Идентификатор месторождения | int4 | Да | Без изменений |
| TerraProject | Проект Терра | varchar | Да | Добавить |
| ParameterDate | Дата начала ИП (месяц-год) | timestamp | Да | Добавить |
| EraEventTypeGroupId | Мероприятие (Вид инвест проекта) | bigint | Да | Изменить |
| GtmCode | Подгруппа мероприятий (ОИС) | text | Нет | Добавить |
| CalcLength | Горизонт расчёта, года | int4 | Да | Добавить |
| NumberWells | Количество скважин в проекте | int4 | Да | Добавить |
| Cost | Затраты, млн. руб. | float8 | Да | Добавить |
| DNS | Мин. рент. ДДН по ДНС, тыс.т | float8 | Да | Добавить |
| NDD | Мин. рент. ДДН по НДД, тыс.т | float8 | Да | Добавить |
| MinRentProductionBagen | Бажен КД=0, тыс. т | float8 | Нет | Добавить |
| MinRentProductionKD02 | 2 категория КД=0,2, тыс. т | float8 | Нет | Добавить |
| MinRentProductionKD04 | 3 категория КД=0,4, тыс. т | float8 | Нет | Добавить |
| MinRentProductionKD08 | Тюменская свита КД=0,8, тыс. т | float8 | Нет | Добавить |
| MinRentProductionTerBenefits | Территориальные льготы, тыс. т | float8 | Нет | Добавить |
| MinRentProductionLatitude65 | Разработка за 65 широтой, тыс. т | float8 | Нет | Добавить |
| MinRentProductionPercent80 | Выработка более 80%, тыс. т | float8 | Нет | Добавить |

#### 2.5.3 Уникальный ключ записи
Комбинация полей:
- OrgId
- FieldId
- TerraProject
- EraEventTypeGroupId
- GtmCode
- ParameterDate

#### 2.5.4 Логика сохранения
При сохранении происходит **полная перезапись** данных по ДО за выбранный год (год в поле `ParameterDate`).

### 2.6 История загрузок

#### 2.6.1 Хранение истории
Информация сохраняется в сущности `business_audit.ParamChangeHistory`.

#### 2.6.2 Новые поля в ParamChangeHistory
- **ImportErrors** (text) - Ошибки в загруженном файле
- **Year** (int) - Год проекта

#### 2.6.3 Заполняемые поля при сохранении записи
- Id - идентификатор записи
- ChangeType - способ изменения данных
- OrgId - ИД ДО
- EntityName = "MinProductionLevelSettings"
- UserId - ИД пользователя
- ReasonNote - Причина изменения (комментарий)
- UpdateDate - Время внесения изменений
- SavedDateTime - Время сохранения в БД
- ImportErrors - Ошибки в загруженном файле
- Year - Год проекта

**Важно:** При сохранении новой записи необходимо очищать поле `ImportErrors` в предыдущей записи по выбранному ДО и году.

#### 2.6.4 Отображение в интерфейсе
История отображается в виде карточек, отсортированных по убыванию даты.

**Содержимое карточки:**
- Дата
- ФИО пользователя
- Комментарий
- Ошибки (только для самой новой загрузки)

**Особенности отображения ошибок:**
- Ограничение первыми тремя строками
- Кликабельное слово "Подробнее" при превышении объема
- Всплывающее окно с полным текстом и вертикальным скроллбаром

### 2.7 Скачивание данных в Excel

#### 2.7.1 Функционал
По нажатию кнопки "Скачать Excel" происходит скачивание файла с данными таблицы за выбранный год.

**Особенности:**
- Данные соответствуют отображаемым в интерфейсе
- Выгружается только за выбранный год
- При пустой таблице выгружаются только заголовки
- Шаблон соответствует шаблону загрузки

#### 2.7.2 API метод
Необходимо создать новый метод: `GET /api/monitoring/v1/Profitability/SettingsExcel`

**Параметры:**
- OrganizationId (array, int32) - Идентификатор организации
- Year (integer) - Год проекта

**Промежуточное решение:** Скачивание реализовать на фронтенде средствами ag-grid.

### 2.8 Инструменты сервиса

В блоке "Monitoring" добавить метод:
**"Загрузить файл с минимальной рентабельной добычей"**

**Обязательные поля настройки:**
- ДО
- Год
- Окно для загрузки файла

При загрузке обрабатываются только данные по выбранному году.

## 3. API методы

### 3.1 Существующие методы (требуют доработки)

#### 3.1.1 Загрузка файла
`/api/monitoring/v1/Profitability/Upload`

**Добавить в request:**
```json
"year": {
    "type": "integer"
}
```

#### 3.1.2 Получение данных таблицы
Текущий: `/api/monitoring/v1/Profitability/GetMinProductionLevel`

Новый: `GET /api/monitoring/v1/MinProductionLevelSettings/GetMinProductionLevelSettings`

**Добавить параметр:**
```json
{
    "name": "year",
    "in": "query",
    "description": "Год начала ИП",
    "schema": {
        "type": "integer"
    }
}
```

**Пример ответа:**
```json
{
    "id": "adaf5fe3-bdd0-4a43-9fa0-0bb78dcce123",
    "orgId": 6,
    "fieldId": 1,
    "fieldName": "Тайлаковское",
    "terraProject": "TerraProject1",
    "eraEventTypeGroupId": 20001,
    "gtmTypeERAName": "ГТМ/ОПТ",
    "gtmCode": "VR300003",
    "gtmTypeVRName": "Оптимизация",
    "parameterDate": "2025-01-01T00:00:00",
    "calcLength": 1.0,
    "numberWells": 1,
    "cost": 1.0,
    "dns": 1.0,
    "ndd": 1.0,
    "minRentProductionBagen": 1.0,
    "minRentProductionKD02": 1.0,
    "minRentProductionKD04": 1.0,
    "minRentProductionKD08": 1.0,
    "minRentProductionTerBenefits": 1.0,
    "minRentProductionPercent80": 1.0,
    "minRentProductionLatitude65": 1.0
}
```

#### 3.1.3 История загрузок
`/api/monitoring/v1/Profitability/GetUploadHistory`

**Добавить параметр:**
```json
{
    "name": "year",
    "in": "query",
    "description": "Год проекта",
    "schema": {
        "type": "integer",
        "format": "int32"
    }
}
```

**Добавить в ответ:**
```json
"importErrors": {
    "type": "string",
    "description": "Ошибки в загруженном файле",
    "nullable": true
}
```

### 3.2 Новые методы

#### 3.2.1 Скачивание Excel
`GET /api/monitoring/v1/Profitability/SettingsExcel`

**Параметры:**
- OrganizationId (query, array, int32)
- Year (query, integer)

**Ответ:** 200 Success

**Security:** bearerAuth

## 4. Роли и права доступа

### 4.1 Роль "Эксперт" (Суперпользователь)
- Загрузка данных только за текущий или будущие года
- Доступ к просмотру данных за любой год

### 4.2 Роль "Специалист поддержки"
- Загрузка данных за любой год
- Полный доступ к функционалу

### 4.3 Прочие роли
- Только просмотр (без возможности загрузки)

## 5. Техническая реализация

### 5.1 Frontend задачи
1. Реализовать отображение таблицы МРД в настройках
2. Реализовать округление значений в полях
3. Реализовать отображение тултипа для поля "ДНС"
4. Реализовать отображение истории загрузок в боковой панели
5. Реализовать функционал загрузки и скачивания Excel
6. Реализовать выпадающий список выбора года
7. Реализовать модальное окно загрузки

### 5.2 Backend задачи
1. Переработать таблицу `MinProductionLevelSettings` (добавить новые поля)
2. Переиспользовать метод заполнения таблицы из Excel
3. Реализовать валидацию загруженных данных
4. Переработать API-метод `GetUploadHistory`
5. Переработать API-метод `GetMinProductionLevel`
6. Создать новый метод `SettingsExcel` для скачивания
7. Добавить метод в инструменты сервиса
8. Расширить таблицу `ParamChangeHistory` новыми полями

### 5.3 База данных
**Изменения в MinProductionLevelSettings:**
- Добавить 14 новых полей
- Изменить существующее поле `EraEventTypeGroupId`

**Изменения в ParamChangeHistory:**
- Добавить поле `ImportErrors` (text)
- Добавить поле `Year` (int)

## 6. Критерии приемки

### 6.1 Отображение интерфейса
- [x] Вкладка "Минимальная рентабельная добыча" отображается
- [x] Вкладки "Минимальный рентабельный прирост" и "Минимальная рентабельная приемистость" скрыты
- [x] По умолчанию открывается вкладка МРД
- [x] Отображаются все компоненты: таблица, панель инструментов, боковая панель, выпадающий список

### 6.2 Выпадающий список года
- [x] Отображаются года с 2020 по 2035 (на 10 лет вперед от текущего)

### 6.3 Таблица МРД
- [x] При отсутствии данных отображаются только заголовки
- [x] Сортировка по умолчанию по месторождению, коду проекта, типу проекта
- [x] Доступна ручная сортировка и фильтрация для всех столбцов
- [x] Тултип для столбца "ДНС" работает корректно
- [x] Значения округляются согласно правилам

### 6.4 Кнопки загрузки/скачивания
- [x] Для текущего/будущего года обе кнопки доступны
- [x] Для прошлых лет кнопка "Загрузить" скрыта, "Скачать" доступна

### 6.5 Боковая панель
- [x] Отображается история за выбранный год и ДО
- [x] Карточки отсортированы по убыванию даты
- [x] Отображаются все необходимые поля
- [x] Ошибки показываются только для последней загрузки
- [x] Работает функционал "Подробнее" для ошибок

### 6.6 Загрузка данных
- [x] Модальное окно открывается корректно
- [x] Отображается информер с требованиями
- [x] Поле комментария обязательно для заполнения
- [x] Кнопка "Загрузить" активна только при наличии файла и комментария
- [x] Во время обработки кнопки недоступны
- [x] Сохраняются только строки без ошибок
- [x] Происходит полная перезапись данных за выбранный год
- [x] Запись о действии сохраняется в историю

### 6.7 Скачивание данных
- [x] Файл скачивается корректно
- [x] Структура соответствует шаблону
- [x] Данные соответствуют отображению в интерфейсе

### 6.8 Инструменты сервиса
- [x] Метод "Загрузить файл с минимальной рентабельной добычей" доступен
- [x] Можно указать ДО, год и загрузить файл

## 7. Глоссарий

| Термин | Расшифровка |
|--------|-------------|
| МРД | Минимальная рентабельная добыча |
| ДДН | Действующая налоговая система |
| НДД | Налог на дополнительный доход |
| ТРИЗ | Трудноизвлекаемый фонд |
| ИП | Инвестиционный проект |
| ДО | Дочерняя организация |
| ППДН | План повышения добычи нефти |
| ГТМ | Геолого-технические мероприятия |
| ОПТ | Оптимизация |
| КД | Коэффициент дисконтирования |

## 8. Ссылки на документацию

- Техническое задание: [ТТ 409441](https://alm-itsk.gazprom-neft.local:8080/TFS/GPN/U210001901_spektr/_workitems/edit/409441)
- Макет интерфейса: [Figma](https://www.figma.com/design/m4H5djVndmvW6LpfVx3W8h/%D0%98%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B9%D1%81-%D0%A1%D0%9F%D0%B5%D0%BA%D0%A2%D0%A0?node-id=11583-15402&t=zVBtnRx9UkKCIO5i-4)

## 9. Выводы и рекомендации

### 9.1 Ключевые моменты реализации
1. **Полная перезапись данных** при загрузке - необходимо предусмотреть механизм резервного копирования
2. **Многоуровневая валидация** - критична для целостности данных
3. **Ролевая модель** - важно корректно разграничить права доступа
4. **История изменений** - необходима для аудита и отката изменений

### 9.2 Потенциальные риски
1. Большой объем изменений в БД (14 новых полей в основной таблице)
2. Необходимость миграции данных из старых таблиц
3. Сложная валидация со множеством проверок
4. Зависимость от внешних справочников СПекТР

### 9.3 Рекомендации
1. Разработать детальный план миграции данных
2. Реализовать механизм отката загрузки в случае критических ошибок
3. Предусмотреть логирование всех операций
4. Провести нагрузочное тестирование при загрузке больших файлов
5. Реализовать валидацию шаблона файла перед обработкой данных